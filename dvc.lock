schema: '2.0'
stages:
  prepare:
    cmd: gunzip -k data/gwas/homo_sapiens_ensembl_107/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz
      && unzip -o -d data/ensembl/107 data/ensembl/107/107.zip && mv data/ensembl/107/VEP_plugins-release-107
      data/ensembl/107/plugins
    deps:
    - path: data/ensembl/107/107.zip
    - path: data/gwas/homo_sapiens_ensembl_107/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz
    outs:
    - path: data/ensembl/107/plugins
    - path: data/gwas/homo_sapiens_ensembl_107/Homo_sapiens.GRCh38.dna.primary_assembly.fa
  start:
    cmd: docker-compose up
  stop:
    cmd: docker-compose down
  cache:
    cmd: tar -C  data/ensembl/107/cache/ -zxvf data/ensembl/107/cache/homo_sapiens_vep_107_GRCh38.tar.gz
    deps:
    - path: data/ensembl/107/cache/homo_sapiens_vep_107_GRCh38.tar.gz
    outs:
    - path: data/ensembl/107/cache/homo_sapiens
  prepare_genome:
    cmd: gunzip -k data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz
      && samtools faidx data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa
      && samtools dict data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa
      -o data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.dict
      md5sum data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.*
      > data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.md5
    deps:
    - path: data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz
    outs:
    - path: data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa
    - path: data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.dict
    - path: data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.fai
    - path: data/ensembl/107/species/Homo_sapiens/Homo_sapiens.GRCh38.dna.primary_assembly.fa.md5
  prepare_vep:
    cmd: unzip -u data/ensembl/107/107.zip -d data/ensembl/107/ && mv data/ensembl/107/VEP_plugins-release-107
      data/ensembl/107/plugins
    deps:
    - path: data/ensembl/107/107.zip
    - path: data/ensembl/107/cache/homo_sapiens_vep_107_GRCh38.tar.gz
    outs:
    - path: data/ensembl/107/plugins/
  prepare_annotations:
    cmd: "gunzip -c data/gwas/annotations/all_variant_disease_pmid_associations.tsv.gz\
      \ |\n   awk '($1 ~ /^snpId/ || $2 ~ /NA/) {next} {print $0}' |\n   sort -t $'\\\
      t' -k2,2 -k3,3n |\n   awk '{ gsub (/\\t +/, \"\\t\", $0); print}' |\n   bgzip\
      \ -c > data/gwas/annotations/all_variant_disease_pmid_associations_final.tsv.gz\
      \ &&\nrm -f data/gwas/annotations/gene2phenotype/AllG2P.csv && awk '(NR == 1)\
      \ || (FNR > 1)' data/gwas/annotations/gene2phenotype/*.csv  > data/gwas/annotations/gene2phenotype/AllG2P.csv"
    deps:
    - path: data/gwas/annotations/all_variant_disease_pmid_associations.tsv.gz
    - path: data/gwas/annotations/clinvar.vcf.gz
    - path: data/gwas/annotations/clinvar.vcf.gz.tbi
    - path: data/gwas/annotations/gene2phenotype/CancerG2P.csv
    - path: data/gwas/annotations/gene2phenotype/DDG2P.csv
    - path: data/gwas/annotations/gene2phenotype/EyeG2P.csv
    - path: data/gwas/annotations/gene2phenotype/SkinG2P.csv
    outs:
    - path: data/gwas/annotations/all_variant_disease_pmid_associations_final.tsv.gz
    - path: data/gwas/annotations/gene2phenotype/AllG2P.csv
  prepare_vep_plugins:
    cmd: unzip -u data/ensembl/107/107.zip -d data/ensembl/107/ && mv data/ensembl/107/VEP_plugins-release-107
      data/ensembl/107/plugins
    deps:
    - path: data/ensembl/107/107.zip
    outs:
    - path: data/ensembl/107/plugins/
  prepare_vep_cache:
    cmd: tar -zxf data/ensembl/107/homo_sapiens_vep_107_GRCh38.tar.gz -C data/ensembl/107/cache/
      && md5sum data/ensembl/107/homo_sapiens_vep_107_GRCh38.tar.gz > data/ensembl/107/homo_sapiens_vep_107_GRCh38.tar.gz.md5
    deps:
    - path: data/ensembl/107/homo_sapiens_vep_107_GRCh38.tar.gz
    outs:
    - path: data/ensembl/107/cache/homo_sapiens
  prepare_annotations_clinvar:
    cmd: echo "Clinvars annotations prepared"
    deps:
    - path: data/gwas/annotations/clinvar.vcf.gz
    - path: data/gwas/annotations/clinvar.vcf.gz.tbi
  prepare_annotations_gene2phenotype:
    cmd: rm -f data/gwas/annotations/gene2phenotype/AllG2P.csv && awk '(NR == 1) ||
      (FNR > 1)' data/gwas/annotations/gene2phenotype/*.csv  > data/gwas/annotations/gene2phenotype/AllG2P.csv
    deps:
    - path: data/gwas/annotations/gene2phenotype/CancerG2P.csv
    - path: data/gwas/annotations/gene2phenotype/DDG2P.csv
    - path: data/gwas/annotations/gene2phenotype/EyeG2P.csv
    - path: data/gwas/annotations/gene2phenotype/SkinG2P.csv
    outs:
    - path: data/gwas/annotations/gene2phenotype/AllG2P.csv
  prepare_annotations_digenet:
    cmd: "gunzip -c data/gwas/annotations/all_variant_disease_pmid_associations.tsv.gz\
      \ |\n   awk '($1 ~ /^snpId/ || $2 ~ /NA/) {next} {print $0}' |\n   sort -t $'\\\
      t' -k2,2 -k3,3n |\n   awk '{ gsub (/\\t +/, \"\\t\", $0); print}' |\n   bgzip\
      \ -c > data/gwas/annotations/all_variant_disease_pmid_associations_final.tsv.gz"
    deps:
    - path: data/gwas/annotations/all_variant_disease_pmid_associations.tsv.gz
    outs:
    - path: data/gwas/annotations/all_variant_disease_pmid_associations_final.tsv.gz
  prepare_opencravat:
    cmd: ov module install-base
  test_opencravat:
    cmd: ov new example-input . && ov run ./example_input -l hg38 && ov gui example_input/example_input.sqlite
  install_opencravat:
    cmd: ov module install-base && ov module install -y clinvar clinvar_acmg biogrid
      uk10k_cohort uniprot pubmed provean polyphen2 cardioboost civic civic_gene cosmic
      cosmic_gene go sift ensembl_regulatory_build dgi cvdkp
  install_cancer:
    cmd: ov module install chasmplus cgc cgl cancer_genome_interpreter cancer_hotspots
      civic
  prepare_annotations_longevity:
    cmd: wget -qO- --timestamping https://genomics.senescence.info/longevity/longevity_genes.zip
      | bsdtar -xvf- -C data/gwas/annotations/ longevity.csv
    outs:
    - path: data/gwas/annotations/longevity.csv